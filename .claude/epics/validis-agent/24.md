---
name: Query Optimizer Agent
status: open
created: 2025-09-10T11:41:46Z
updated: 2025-09-10T11:55:24Z
github: https://github.com/validis-group-holdings/validis-agent-psc/issues/24
depends_on: [002]
parallel: true
conflicts_with: []
---

# Task: Query Optimizer Agent

## Description
Build the Query Optimizer Agent that reviews SQL generated by domain agents and ensures it uses proper indexes (uploadId), adds safety limits, applies multi-tenant filtering, and validates query syntax.

## Acceptance Criteria
- [ ] All queries use clustered index (uploadId)
- [ ] Result limits applied (5000 rows max)
- [ ] Multi-tenant filtering (client_id) always present
- [ ] Portfolio queries limited to 3-month window
- [ ] Query execution plan analyzed for performance
- [ ] Dangerous operations blocked (DROP, DELETE, UPDATE)

## Technical Details
- Parse SQL to verify index usage
- Add LIMIT/TOP clauses if missing
- Inject client_id filter from environment
- Use SQL parser library for validation
- Log optimization decisions for debugging

## Dependencies
- [ ] Task 002 completed (database context with indexes)
- [ ] Understanding of SQL Server query plans

## Effort Estimate
- Size: M
- Hours: 12-16
- Parallel: true (can work alongside other agents)

## Definition of Done
- [ ] Optimizer correctly modifies 100% of test queries
- [ ] All optimized queries use indexes
- [ ] Multi-tenant isolation verified
- [ ] Performance improvements measurable
- [ ] Unit tests for optimization rules
- [ ] Integration test with domain agents
