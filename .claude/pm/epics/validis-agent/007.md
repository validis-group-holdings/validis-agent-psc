---
name: Mode Management Implementation
status: open
created: 2025-08-28T13:40:28Z
updated: 2025-08-28T14:01:20Z
github: https://github.com/validis-group-holdings/validis-agent-mvp/issues/8
depends_on: [004, 005]
parallel: false
conflicts_with: []
---

# Task: Mode Management Implementation

## Description
Implement audit and lending workflow rules with proper upload_id scoping, client isolation, and mode-specific behaviors based on environment configuration or JWT claims.

## Acceptance Criteria
- [ ] Audit mode enforces single company context
- [ ] Lending mode enables portfolio queries with drill-down
- [ ] Client_id filtering applied to all queries
- [ ] Mode configuration from environment variable (POC)
- [ ] JWT claim reading prepared for production
- [ ] Mode cannot be switched during session
- [ ] Context persistence across conversation
- [ ] Proper scoping validation on every query

## Technical Details
- Implementation approach: Strategy pattern for mode behaviors
- Key files: `src/modes/audit.ts`, `src/modes/lending.ts`
- Session management with mode locking
- Context validation middleware
- Mode-specific query constraints

Mode behaviors:
- Audit Mode:
  - Set company context at start
  - All queries scoped to single upload_id
  - Historical comparisons within company
  - Cannot access other companies
  
- Lending Mode:
  - Portfolio-wide queries by default
  - Drill-down to specific companies
  - Navigation between portfolio and company views
  - Comparison across multiple companies

## Dependencies
- [ ] Task 004 (Agent Pipeline) completed
- [ ] Task 005 (API Development) completed
- [ ] Session management implemented

## Effort Estimate
- Size: M
- Hours: 12-16
- Parallel: false (depends on agents and API)

## Definition of Done
- [ ] Both modes fully implemented and tested
- [ ] Mode enforcement validated with security tests
- [ ] Context persistence working across queries
- [ ] Documentation of mode behaviors
- [ ] Integration tests for mode-specific scenarios